-- 01_empleados_rrhh.sql
START TRANSACTION;

-- Empleado (apunta a datos_persona)
CREATE TABLE IF NOT EXISTS empleado (
  id_empleado INT NOT NULL AUTO_INCREMENT,
  id_datos_persona INT NOT NULL,
  PRIMARY KEY (id_empleado),
  KEY (id_datos_persona)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

-- Contrato del empleado (uno vigente; puedes permitir históricos si quieres)
CREATE TABLE IF NOT EXISTS contrato_empleado (
  id_contrato INT NOT NULL AUTO_INCREMENT,
  id_empleado INT NOT NULL,
  cargo VARCHAR(120) NOT NULL,
  id_tipo_contrato INT NOT NULL,
  departamento VARCHAR(120) NULL,
  fecha_contratacion DATE NOT NULL,
  salario_base DECIMAL(12,2) NOT NULL,
  id_jefe INT NULL,                -- (empleado superior)
  vigente TINYINT(1) DEFAULT 1,
  PRIMARY KEY (id_contrato),
  KEY (id_empleado),
  KEY (id_tipo_contrato),
  KEY (id_jefe)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

-- Cabecera de nómina por periodo (YYYY-MM)
CREATE TABLE IF NOT EXISTS nomina (
  id_nomina INT NOT NULL AUTO_INCREMENT,
  periodo CHAR(7) NOT NULL,            -- p.ej. '2025-11'
  generado_en TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id_nomina),
  UNIQUE KEY (periodo)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

-- Detalle de nómina por empleado
CREATE TABLE IF NOT EXISTS nomina_empleado (
  id_nomina_empleado INT NOT NULL AUTO_INCREMENT,
  id_nomina INT NOT NULL,
  id_empleado INT NOT NULL,
  salario_base DECIMAL(12,2) NOT NULL,
  horas_extra DECIMAL(8,2) NOT NULL DEFAULT 0,
  bonificaciones DECIMAL(12,2) NOT NULL DEFAULT 0,
  deducciones DECIMAL(12,2) NOT NULL DEFAULT 0,
  salario_neto DECIMAL(12,2) NOT NULL,
  PRIMARY KEY (id_nomina_empleado),
  KEY (id_nomina),
  KEY (id_empleado)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

COMMIT;

-- ===== Seguridad: roles, permisos y asignaciones =====
-- Nota: mantengo MyISAM para ser consistente con tu dump. Si migras a InnoDB, añade FKs.

CREATE TABLE IF NOT EXISTS permiso (
  id_permiso INT NOT NULL AUTO_INCREMENT,
  clave VARCHAR(50) NOT NULL UNIQUE,   -- 'prestamos','clientes','rrhh','admin'
  nombre VARCHAR(100) NOT NULL,        -- Etiqueta visible
  PRIMARY KEY (id_permiso)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS rol (
  id_rol INT NOT NULL AUTO_INCREMENT,
  nombre VARCHAR(80) NOT NULL UNIQUE,
  creado_en TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id_rol)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS rol_permiso (
  id_rol INT NOT NULL,
  id_permiso INT NOT NULL,
  PRIMARY KEY (id_rol, id_permiso),
  KEY (id_rol),
  KEY (id_permiso)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS usuario_rol (
  id_usuario INT NOT NULL,
  id_rol INT NOT NULL,
  PRIMARY KEY (id_usuario, id_rol),
  KEY (id_usuario),
  KEY (id_rol)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4;

-- Semilla de permisos básicos
INSERT IGNORE INTO permiso (clave, nombre) VALUES
('prestamos', 'Administrar préstamos'),
('clientes',  'Administrar clientes'),
('rrhh',      'Administrar RRHH'),
('admin',     'Administración general');

Soporte de “número de contrato”:
ALTER TABLE prestamo ADD COLUMN numero_contrato VARCHAR(50) UNIQUE NULL;

INSERT INTO cat_tipo_pago (tipo_pago)
SELECT 'Garantía' WHERE NOT EXISTS(
  SELECT 1 FROM cat_tipo_pago WHERE tipo_pago='Garantía'
);

ALTER TABLE pago ADD COLUMN observacion TEXT NULL;


